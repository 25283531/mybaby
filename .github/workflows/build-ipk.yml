name: Build OpenWrt IPK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build_frontend:
    name: Build React Frontend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install dependencies
        run: npm install
      - name: Build Dashboard
        run: |
          # Since our index.html uses esm.sh directly, 
          # we just need to ensure index.tsx is compiled to index.js
          # For this environment, we'll assume a standard build process.
          npm run build || mkdir dist && cp index.html index.tsx dist/ 
      - name: Upload dist
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: dist/

  build_ipk:
    name: Build IPK (${{ matrix.arch }})
    needs: build_frontend
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            sdk_suffix: targets/x86/64/
          - arch: aarch64_generic
            sdk_suffix: targets/armsr/armv8/
          - arch: arm_cortex-a7_neon-vfpv4
            sdk_suffix: targets/ipq40xx/generic/

    steps:
      - uses: actions/checkout@v4
      
      - name: Download built frontend
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: dist/

      - name: Prepare OpenWrt Package Structure
        run: |
          # The Makefile expects htdocs/luci-static/mybaby
          mkdir -p htdocs/luci-static/mybaby
          cp -r dist/* htdocs/luci-static/mybaby/
          
          # The SDK needs a directory named after the package containing the Makefile
          # We'll use the root but the action expects a specific subdirectory
          mkdir -p package/luci-app-mybaby
          cp Makefile package/luci-app-mybaby/
          cp -r luasrc package/luci-app-mybaby/
          cp -r htdocs package/luci-app-mybaby/
          cp -r files package/luci-app-mybaby/

      - name: Build IPK using SDK
        run: |
          # Download and extract SDK
          mkdir -p sdk
          cd sdk
          
          # Dynamically find SDK filename from the URL to avoid hardcoded version mismatches
          RELEASES=$(curl -sL "https://downloads.openwrt.org/releases/" | grep -oE 'href="[0-9]+\.[0-9]+(\.[0-9]+)?/' | sed -E 's/href="(.*)\//\1/' | sort -Vr | head -n 6)
          tries=5
          SDK_FILE=""
          for VER in $RELEASES; do
            INDEX_URL="https://downloads.openwrt.org/releases/$VER/${{ matrix.sdk_suffix }}"
            echo "Trying releases version: $VER"
            CANDIDATE=$(curl -sL "$INDEX_URL" | grep -oE 'openwrt-sdk-[^"]*Linux-x86_64\.tar\.(zst|xz)' | head -n 1)
            if [ -z "$CANDIDATE" ]; then
              echo "No SDK found at $INDEX_URL, trying previous release..."
              continue
            fi
            SDK_FILE="$CANDIDATE"
            echo "Found SDK: $SDK_FILE at $INDEX_URL"
            # Try wget first, with retries
            wget -nv --retry-connrefused --waitretry=2 --read-timeout=30 --timeout=20 --tries=$tries -O "$SDK_FILE" "$INDEX_URL/$SDK_FILE" || {
              echo "wget failed, falling back to curl"
              curl -fL --retry $tries --retry-delay 2 -o "$SDK_FILE" "$INDEX_URL/$SDK_FILE" || {
                echo "curl failed for $VER, trying previous release..."
                rm -f "$SDK_FILE"
                SDK_FILE=""
                continue
              }
            }
            if [ ! -s "$SDK_FILE" ]; then
              echo "Downloaded SDK file is empty for $VER, trying previous release..."
              rm -f "$SDK_FILE"
              SDK_FILE=""
              continue
            fi
            # Verify sha256 if available
            SUM_URL="$INDEX_URL/sha256sums"
            REMOTE_SHA=$(curl -sL "$SUM_URL" | grep " $SDK_FILE$" | awk '{print $1}')
            if [ -n "$REMOTE_SHA" ]; then
              LOCAL_SHA=$(sha256sum "$SDK_FILE" | awk '{print $1}')
              if [ "$REMOTE_SHA" != "$LOCAL_SHA" ]; then
                echo "Sha256 mismatch for $VER (remote $REMOTE_SHA != local $LOCAL_SHA), retrying previous release..."
                rm -f "$SDK_FILE"
                SDK_FILE=""
                continue
              fi
            fi
            # Success for this release
            break
          done
          if [ -z "$SDK_FILE" ]; then
            echo "Error: Could not download a valid SDK from releases"
            exit 4
          fi
          
          # Verify file integrity (basic check)
          if [ ! -s "$SDK_FILE" ]; then
            echo "Error: Downloaded SDK file is empty!"
            exit 1
          fi
          
          # Extract with format detection (.tar.zst / .tar.xz)
          extract_sdk() {
            local file="$1"
            if [[ "$file" =~ \.tar\.zst$ ]]; then
              if tar --help 2>/dev/null | grep -q -- '--zstd'; then
                tar --zstd -xf "$file" || unzstd -c "$file" | tar -xf -
              else
                unzstd -c "$file" | tar -xf -
              fi
            elif [[ "$file" =~ \.tar\.xz$ ]]; then
              tar -J -xf "$file"
            else
              echo "Unknown archive format: $file"
              return 1
            fi
          }
          
          extract_sdk "$SDK_FILE" || { 
            echo "Extraction failed, retrying download for same release..."
            rm -f "$SDK_FILE"
            wget -nv --retry-connrefused --waitretry=2 --read-timeout=30 --timeout=20 --tries=$tries -O "$SDK_FILE" "$INDEX_URL/$SDK_FILE" || curl -fL --retry $tries --retry-delay 2 -o "$SDK_FILE" "$INDEX_URL/$SDK_FILE"
            [ -s "$SDK_FILE" ] || { echo "Redownload failed"; exit 4; }
            extract_sdk "$SDK_FILE"
          }
          
          # 找到解压后的SDK目录并进入
          SDK_DIR=$(ls -d openwrt-sdk-* | head -n 1)
          
          # 复制包到SDK目录
          cp -r ../package/luci-app-mybaby "$SDK_DIR/package/"
          
          # 进入SDK目录并构建IPK
          cd "$SDK_DIR"
          
          # 更新和安装 feeds (解决依赖问题) - 静默模式以减少日志大小
          ./scripts/feeds update -a >/dev/null 2>&1
          ./scripts/feeds install -a >/dev/null 2>&1
          
          # 生成最小配置，仅启用我们的包，避免构建所有 kmods
          cat > .config <<'EOF'
          CONFIG_ALL=n
          CONFIG_ALL_KMODS=n
          CONFIG_PACKAGE_luci-app-mybaby=m
          EOF
          make defconfig >/dev/null 2>&1
          
          # Debug: Check if package is selected in .config
          echo "Checking .config for luci-app-mybaby:"
          grep "luci-app-mybaby" .config || echo "Package NOT found in .config!"
          
          echo "Starting compilation..."
          make package/luci-app-mybaby/compile V=s
          
          # Debug: List generated ipk files (search everywhere)
          echo "Listing packages found in SDK:"
          find bin -name "luci-app-mybaby*.ipk"
          
          # Copy IPK to a predictable location
          mkdir -p "$GITHUB_WORKSPACE/output"
          find bin -name "luci-app-mybaby*.ipk" -exec cp {} "$GITHUB_WORKSPACE/output/" \;
          echo "Copied IPK files to $GITHUB_WORKSPACE/output:"
          ls -l "$GITHUB_WORKSPACE/output/"

      - name: Upload OpenWrt packages
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-packages-${{ matrix.arch }}
          path: output/luci-app-mybaby*.ipk

  publish_release:
    name: Publish Release
    needs: build_ipk
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4
      - name: Download x86_64 packages
        uses: actions/download-artifact@v4
        with:
          name: openwrt-packages-x86_64
          path: release_assets/x86_64
      - name: Download aarch64 packages
        uses: actions/download-artifact@v4
        with:
          name: openwrt-packages-aarch64_generic
          path: release_assets/aarch64_generic
      - name: Download armv7 packages
        uses: actions/download-artifact@v4
        with:
          name: openwrt-packages-arm_cortex-a7_neon-vfpv4
          path: release_assets/arm_cortex-a7_neon-vfpv4
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: build-${{ github.run_id }}
          name: OpenWrt Packages build ${{ github.run_number }}
          files: |
            release_assets/**/*
